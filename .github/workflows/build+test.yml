name: Build and test for all  platforms

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: 0 0 * * *

jobs:
  build_and_test_xcode:
    name: Build and test all  platforms (xcode 13)
    runs-on: macos-11
    continue-on-error: true
    env:
      xcodebuildcommand: test
      schemename: Earendil
      iosdevice: 'iPhone 12 Pro'
      iosversion: '15.0'
      tvosdevice: 'Apple TV 4K (2nd generation)'
      tvosversion: '15.0'
      watchosdevice: 'Apple Watch Series 6 - 40mm'
      watchosversion: '8.0'
#     strategy:
#       fail-fast: false
#       matrix:
#         xcodeversion: [13.0, 12.5.1, 12.4]
#         xcodebuildcommand: [test]
#         schemename: [Earendil]
        
    steps:
    - name: xcode switch
      uses: maxim-lobanov/setup-xcode@v1.2.3
      with:
        xcode-version: '13.0'
    - name: Code Checkout
      uses: actions/checkout@v2
    - name: Check xcodebuild version
      run: xcodebuild -version
    - name: Check xcode embedded SDKs
      run: xcodebuild -showsdks
    - name: Show buildable schemes
      run: xcodebuild -list
    - name: Show eligible build destinations
      run: xcodebuild -showdestinations -scheme Earendil  
    - name: Build and test on  ${{ env.iosdevice }}, ${{ env.iosversion }}
      run: xcodebuild ${{ env.xcodebuildcommand }} -scheme ${{ env.schemename }} -destination 'platform=iOS Simulator,OS=${{ iosversion }},name=${{ env.iosdevice }}'
    - name: Build and test on  ${{ env.tvosdevice }}, ${{ env.tvosversion }}
      run: xcodebuild ${{ env.xcodebuildcommand }} -scheme ${{ env.schemename }} -destination 'platform=tvOS Simulator,OS=${{ tvosversion }},name=${{ env.tvosdevice }}'
    - name: Build and test on  ${{ env.watchosdevice }}, ${{ env.watchosversion }}
#       if: ${{ !startsWith(env.watchosversion, "7") }}
      run: xcodebuild ${{ env.xcodebuildcommand }} -scheme ${{ env.schemename }} -destination 'platform=watchOS Simulator,OS=${{ watchosversion }},name=${{ env.watchosdevice }}'
    - name: Build and test on  macOS
      run: xcodebuild ${{ env.xcodebuildcommand }} -scheme ${{ env.schemename }} -destination 'platform=macOS,arch=x86_64,id=4203018E-580F-C1B5-9525-B745CECA79EB'
    - name: Build and test on  mac Catalyst 
      run: xcodebuild ${{ env.xcodebuildcommand }} -scheme ${{ env.schemename }} -destination 'platform=macOS,arch=x86_64,variant=Mac Catalyst,id=4203018E-580F-C1B5-9525-B745CECA79EB'
